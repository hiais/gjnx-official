---
import Layout from './MainLayout.astro';
import SEO from '../components/structure/SEO.astro';
import RelatedContent from '../components/ui/RelatedContent.astro';

interface Props {
  title: string;
  frontmatter?: any;
  ogImage?: URL;
  id?: string;
  collection?: 'articles' | 'knowledge';
}

const { title, frontmatter, ogImage, id, collection } = Astro.props;
const description = frontmatter?.description || "硅基能效 - Deconstructing Silicon Efficiency";
const keywords = frontmatter?.tags?.join(', ') || "Silicon Efficiency, AI, Chip";
---

<Layout title={title} description={description} image={ogImage} keywords={keywords}>
  <SEO 
    slot="seo"
    title={title} 
    description={description} 
    image={ogImage} 
    type="article" 
    articleData={{
      date: frontmatter?.date,
      tags: frontmatter?.tags,
      author: "Silicon Operator"
    }}
  />

  <!-- WeChat Share Image Hack -->
  <!-- 微信分享会抓取页面里第一张 >300px 的图片，这里我们强制插入 OG 图 -->
  <div style="position:absolute; width:0; height:0; overflow:hidden; z-index:-1; opacity: 0;">
      <img src={ogImage.toString()} alt="WeChat Share Icon" />
  </div>

  <div class="reading-progress-bar" id="progress-bar"></div>
  
  <main class="article-container">
    <!-- Header -->
    <header class="article-header">
      <!-- Breadcrumb: Simplified, no title -->
      <nav class="breadcrumbs mono">
        <a href="/">首页</a>
        <span class="sep">›</span>
        {Astro.url.pathname.startsWith('/knowledge') ? (
          <a href="/knowledge">知识库</a>
        ) : (
          <a href="/articles">深度专栏</a>
        )}
      </nav>
      
      <!-- Title: Maximum prominence, first visual focus -->
      <h1 class="article-title">{title}</h1>
      
      <!-- Meta Row: Tags (left) + Date (right) -->
      <div class="meta-row mono">
        <!-- Tags as inline pills (left) -->
        <div class="meta-tags">
          {frontmatter?.tags?.slice(0, 2).map((tag: string) => (
            <a href={`/tags/${tag}`} class="meta-tag">{tag.split('-')[0]}</a>
          ))}
        </div>
        <!-- Date (right aligned) -->
        <span class="date">
          {frontmatter?.date ? new Date(frontmatter.date).toLocaleDateString('zh-CN', { year: 'numeric', month: 'short', day: 'numeric' }) : ''}
        </span>
      </div>
    </header>

    <!-- Content -->
    <article class="markdown-body">
      <slot />
    </article>

    <!-- Content Intelligence: Related Logs -->
    {id && collection && (
      <RelatedContent 
        currentId={id} 
        collection={collection} 
        tags={frontmatter?.tags} 
      />
    )}

    <!-- Footer CTA -->
    <div class="article-footer-cta">
      <div class="terminal-box">
        <div class="terminal-header">
          <span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span>
          <span>End_of_Stream</span>
        </div>
        <p>
          > Accessing detailed technical specifications...<br>
          > <span class="blink">_</span>
        </p>
        <div class="cta-actions">
          <button id="open-modal" class="btn-scan">关注公众号获取完整白皮书</button>
        </div>
      </div>
    </div>
  </main>

  <!-- WeChat Modal -->
  <dialog id="wechat-modal" class="modal">
    <div class="modal-content">
      <button id="close-modal" class="close-btn">×</button>
      <h3 class="mono">> INITIATING_HANDSHAKE</h3>
      <div class="qr-wrapper">
        <img src="/assets/qrcode.jpg" alt="Silicon Efficiency WeChat QR" width="200" height="200" />
        <div class="scan-line"></div>
      </div>
      <p class="instruction">
        扫描二维码，回复 <span class="highlight">【报告】</span><br>
        立即解锁完整版 PDF 报告
      </p>
    </div>
  </dialog>
</Layout>

<style>
  /* Existing Styles... */

  /* Modal Styles */
  dialog.modal {
    background: transparent;
    border: none;
    padding: 0;
    margin: auto;
    color: white;
    max-width: 90vw;
  }
  
  dialog::backdrop {
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
  }

  .modal-content {
    background: #0a0a0a;
    border: 1px solid var(--c-accent-cyan);
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
    position: relative;
    box-shadow: 0 0 50px rgba(0, 240, 255, 0.2);
  }

  .modal h3 {
    color: var(--c-accent-cyan);
    font-size: 1rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px dashed rgba(255,255,255,0.1);
    padding-bottom: 0.5rem;
  }

  .qr-wrapper {
    position: relative;
    display: inline-block;
    border: 2px solid #333;
    padding: 10px;
    background: white;
    border-radius: 4px;
    overflow: hidden;
  }
  
  /* Cyberpunk Scan Effect */
  .scan-line {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 4px;
    background: var(--c-accent-rose);
    box-shadow: 0 0 10px var(--c-accent-rose);
    animation: scan 2s linear infinite;
    opacity: 0.7;
  }

  .instruction {
    margin-top: 1.5rem;
    font-size: 0.9rem;
    color: #aaa;
    line-height: 1.6;
  }

  .highlight {
    color: var(--c-accent-amber);
    font-weight: bold;
    border: 1px solid var(--c-accent-amber);
    padding: 2px 6px;
    border-radius: 4px;
  }

  .close-btn {
    position: absolute;
    top: 10px; right: 15px;
    background: none;
    border: none;
    color: #666;
    font-size: 1.5rem;
    cursor: pointer;
  }
  .close-btn:hover { color: white; }

  @keyframes scan {
    0% { top: 0%; }
    50% { top: 100%; }
    51% { top: 0%; } /* Instant reset for loop effect */
    100% { top: 0%; }
  }

  /* ... rest of styles */
  
  /* Progress Bar (existing) */
  .reading-progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 0%;
    height: 2px;
    background: var(--c-accent-cyan);
    z-index: 100;
    box-shadow: 0 0 10px var(--c-accent-cyan);
    transition: width 0.1s;
  }

  .article-container {
    max-width: 720px; /* Reduced from 800px for better reading experience */
    margin: 0 auto;
    padding: 6rem 1.5rem;
  }

  /* Breadcrumb Styles */
  .breadcrumbs {
    font-size: 0.8rem;
    color: var(--c-text-muted);
    margin-bottom: 2rem;
  }
  
  .breadcrumbs a {
    color: #888;
    text-decoration: none;
    transition: color 0.2s;
  }
  
  .breadcrumbs a:hover {
    color: var(--c-accent-cyan);
  }
  
  .breadcrumbs .sep {
    margin: 0 0.4rem;
    color: #444;
  }

  /* Tags Row - Pill Style */
  .tags-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  
  .tag-pill {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: rgba(0, 240, 255, 0.1);
    border: 1px solid rgba(0, 240, 255, 0.3);
    border-radius: 20px;
    color: var(--c-accent-cyan);
    text-decoration: none;
    transition: all 0.2s;
  }
  
  .tag-pill:hover {
    background: rgba(0, 240, 255, 0.2);
    border-color: var(--c-accent-cyan);
    box-shadow: 0 0 10px rgba(0, 240, 255, 0.3);
  }

  /* Article Title */
  .article-title {
    font-size: clamp(1.8rem, 5vw, 2.5rem);
    font-weight: 700;
    line-height: 1.3;
    margin-bottom: 1rem;
    color: #fff;
    letter-spacing: -0.02em;
  }

  /* Meta Row: Tags (left) + Date (right) */
  .meta-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: #666;
    padding-bottom: 2rem;
    margin-bottom: 2rem;
    border-bottom: 1px solid #222;
  }
  
  .meta-tags {
    display: flex;
    gap: 0.4rem;
  }
  
  .meta-tag {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    font-size: 0.7rem;
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 0.03em;
    background: rgba(0, 240, 255, 0.08);
    border: 1px solid rgba(0, 240, 255, 0.25);
    border-radius: 3px;
    color: var(--c-accent-cyan);
    text-decoration: none;
    transition: all 0.2s;
  }
  
  .meta-tag:hover {
    background: rgba(0, 240, 255, 0.15);
    border-color: var(--c-accent-cyan);
  }
  
  .dot-sep {
    color: #444;
  }
  
  .meta-row .author {
    color: var(--c-accent-cyan);
  }

  /* ... */

  /* Markdown Content Styling */
  .markdown-body {
    font-size: 1.15rem; /* Slightly larger base size */
    line-height: 1.9;
    color: #e0e0e0;
    max-width: 65ch; /* Optical width for reading */
    margin: 0 auto;
  }
  
  /* These styles will target the rendered markdown */
  .markdown-body :global(h2) {
    font-size: 1.8rem;
    margin-top: 4rem; /* More breathing room */
    margin-bottom: 1.5rem;
    color: white;
    border-left: 4px solid var(--c-accent-cyan);
    padding-left: 1rem;
    line-height: 1.3;
  }

  .markdown-body :global(h3) {
    font-size: 1.4rem;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    color: var(--c-text-primary);
  }

  .markdown-body :global(p) {
    margin-bottom: 1.8rem; /* Relaxed paragraph spacing */
  }

  .markdown-body :global(blockquote) {
    border-left: 4px solid var(--c-accent-amber);
    background: rgba(255, 174, 0, 0.08);
    margin: 2.5rem 0;
    padding: 1.5rem 2rem;
    font-family: var(--font-mono);
    font-size: 1rem;
    color: #ffd080;
    border-radius: 0 4px 4px 0;
  }
  .markdown-body :global(pre) {
    background: #111 !important;
    border: 1px solid #333;
    border-radius: 6px;
    padding: 1rem;
    overflow-x: auto;
  }

  /* --- Enhanced Unordered List Styles --- */
  .markdown-body :global(ul) {
    list-style: none;
    padding-left: 0;
    margin: 2rem 0;
  }
  
  .markdown-body :global(ul li) {
    position: relative;
    padding-left: 1.8rem;
    margin-bottom: 1rem;
    line-height: 1.7;
  }
  
  .markdown-body :global(ul li::before) {
    content: '▸';
    position: absolute;
    left: 0;
    color: var(--c-accent-cyan);
    font-weight: bold;
  }
  
  /* --- Ordered List Styles --- */
  .markdown-body :global(ol) {
    padding-left: 1.5rem;
    margin: 2rem 0;
  }
  
  .markdown-body :global(ol li) {
    margin-bottom: 1rem;
    line-height: 1.7;
  }
  
  .markdown-body :global(ol li::marker) {
    color: var(--c-accent-cyan);
    font-weight: bold;
  }

  /* --- Horizontal Rule (Section Divider) --- */
  .markdown-body :global(hr) {
    border: none;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--c-accent-cyan), transparent);
    margin: 3rem 0;
    opacity: 0.5;
  }

  /* --- Strong/Bold with accent color --- */
  .markdown-body :global(strong) {
    color: #fff;
    font-weight: 600;
  }

  /* --- Inline Code Styling --- */
  .markdown-body :global(code:not(pre code)) {
    background: rgba(0, 240, 255, 0.1);
    border: 1px solid rgba(0, 240, 255, 0.2);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9em;
    color: var(--c-accent-cyan);
  }

  /* --- Special Section: 核心提炼 / Core Extraction --- */
  .markdown-body :global(h4),
  .markdown-body :global(h5) {
    font-size: 1.1rem;
    color: var(--c-accent-amber);
    margin-top: 2rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .markdown-body :global(h4)::before,
  .markdown-body :global(h5)::before {
    content: '✦';
    color: var(--c-accent-amber);
  }

  .markdown-body :global(img) {
    max-width: 100%;
    border-radius: 8px;
    border: 1px solid #333;
  }
  
  .btn-scan {
    display: inline-block;
    margin-top: 1rem;
    background: var(--c-accent-cyan);
    color: #000;
    padding: 0.5rem 1rem;
    text-decoration: none;
    font-weight: bold;
    font-size: 0.9rem;
    border-radius: 2px;
    border: none;
    cursor: pointer;
  }
  .btn-scan:hover {
    box-shadow: 0 0 15px rgba(0,240,255,0.4);
  }
  
  /* CTA Stylings */
  .article-footer-cta {
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px dashed #333;
  }

  .terminal-box {
    background: #0f0f0f;
    border: 1px solid #333;
    border-radius: 6px;
    padding: 1rem;
    font-family: var(--font-mono);
  }

  .terminal-header {
    display: flex;
    gap: 6px;
    margin-bottom: 1rem;
    color: #666;
    font-size: 0.8rem;
  }
  
  .blink {
    animation: blink 1s step-end infinite;
  }

  @keyframes blink { 50% { opacity: 0; } }
</style>

<script>
  // Reading Progress Logic
  window.addEventListener('scroll', () => {
    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrolled = (winScroll / height) * 100;
    const bar = document.getElementById('progress-bar');
    if (bar) bar.style.width = scrolled + "%";
  });

  // Modal Logic
  const modal = document.getElementById('wechat-modal') as HTMLDialogElement;
  const openBtn = document.getElementById('open-modal');
  const closeBtn = document.getElementById('close-modal');

  if (modal && openBtn && closeBtn) {
    openBtn.addEventListener('click', () => {
      modal.showModal();
    });

    closeBtn.addEventListener('click', () => {
      modal.close();
    });

    // Close on backdrop click
    modal.addEventListener('click', (e) => {
      const rect = modal.getBoundingClientRect();
      const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.top + rect.height &&
        rect.left <= e.clientX && e.clientX <= rect.left + rect.width);
      if (!isInDialog) {
        modal.close();
      }
    });
  }
</script>
